<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>會員註冊</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>會員註冊</h2>
  <form id="registerForm">
    <label for="name">姓名</label>
    <input type="text" id="name" name="name" required />

    <label for="idNumber">身份證字號</label>
    <input type="text" id="idNumber" name="idNumber" maxlength="10" required pattern="^[A-Z][12]\d{8}$" placeholder="A123456789" />

    <label for="birthday">生日</label>
    <input type="date" id="birthday" name="birthday" required />

    <label for="gender">性別</label>
    <select id="gender" name="gender" required>
      <option value="">請選擇</option>
      <option value="男">男</option>
      <option value="女">女</option>
      <option value="其他">其他</option>
    </select>

    <label for="phone">手機號碼</label>
    <input type="tel" id="phone" name="phone" pattern="09\d{8}" required placeholder="09xxxxxxxx" />

    <label for="addressCity">居住城市</label>
    <select id="addressCity" name="addressCity" required>
      <option value="">請選擇城市</option>
      <option value="基隆市">基隆市</option>
      <option value="台北市">台北市</option>
      <option value="新北市">新北市</option>
      <option value="桃園市">桃園市</option>
      <option value="新竹市">新竹市</option>
      <option value="新竹縣">新竹縣</option>
      <option value="苗栗縣">苗栗縣</option>
      <option value="台中市">台中市</option>
      <option value="彰化縣">彰化縣</option>
      <option value="南投縣">南投縣</option>
      <option value="雲林縣">雲林縣</option>
      <option value="嘉義市">嘉義市</option>
      <option value="嘉義縣">嘉義縣</option>
      <option value="台南市">台南市</option>
      <option value="高雄市">高雄市</option>
      <option value="屏東縣">屏東縣</option>
      <option value="台東縣">台東縣</option>
      <option value="花蓮縣">花蓮縣</option>
      <option value="宜蘭縣">宜蘭縣</option>
      <option value="澎湖縣">澎湖縣</option>
      <option value="金門縣">金門縣</option>
      <option value="連江縣">連江縣</option>
    </select>

    <label for="addressDistrict">居住區域</label>
    <select id="addressDistrict" name="addressDistrict" required>
      <option value="">請先選擇城市</option>
    </select>

    <label for="addressDetail">詳細地址</label>
    <input type="text" id="addressDetail" name="addressDetail" placeholder="如街道門牌" required />

    <label for="registerLocation">註冊據點</label>
    <select id="registerLocation" name="registerLocation" required>
      <option value="">請選擇註冊據點</option>
      <option value="台北富豪">台北富豪</option>
    </select>

    <button type="submit">送出</button>
  </form>

  <script>
    const districtData = {
      "基隆市": ["仁愛區", "信義區", "中正區", "中山區", "安樂區", "暖暖區", "七堵區"],
      "台北市": ["中正區", "大同區", "中山區", "松山區", "大安區", "萬華區", "信義區", "士林區", "北投區", "內湖區", "南港區", "文山區"],
      "新北市": ["板橋區", "三重區", "中和區", "永和區", "新莊區", "新店區", "樹林區", "鶯歌區", "三峽區", "淡水區", "汐止區", "瑞芳區", "土城區", "蘆洲區", "五股區", "泰山區", "林口區", "八里區", "深坑區", "石碇區", "坪林區", "三芝區", "石門區"],
      "桃園市": ["中壢區", "平鎮區", "龍潭區", "楊梅區", "新屋區", "觀音區", "桃園區", "龜山區", "八德區", "大溪區", "復興區", "大園區", "蘆竹區"],
      "新竹市": ["東區", "北區", "香山區"],
      "新竹縣": ["竹北市", "湖口鄉", "新豐鄉", "新埔鎮", "關西鎮", "芎林鄉", "寶山鄉", "竹東鎮", "五峰鄉", "橫山鄉", "尖石鄉", "北埔鄉", "峨眉鄉"],
      "苗栗縣": ["竹南鎮", "頭份市", "三灣鄉", "南庄鄉", "獅潭鄉", "後龍鎮", "通霄鎮", "苑裡鎮", "苗栗市", "造橋鄉", "頭屋鄉", "公館鄉", "大湖鄉", "泰安鄉", "銅鑼鄉", "三義鄉", "西湖鄉", "卓蘭鎮"],
      "台中市": ["中區", "東區", "南區", "西區", "北區", "西屯區", "南屯區", "北屯區","豐原區", "后里區", "石岡區", "東勢區", "和平區", "新社區", "潭子區","大雅區", "神岡區", "大肚區", "沙鹿區", "龍井區", "梧棲區", "清水區","大甲區", "外埔區", "大安區"],
      "彰化縣": ["彰化市", "芬園鄉", "花壇鄉", "秀水鄉", "鹿港鎮", "福興鄉", "線西鄉","和美鎮", "伸港鄉", "員林市", "社頭鄉", "永靖鄉", "埔心鄉", "溪湖鎮","大村鄉", "埔鹽鄉", "田中鎮", "北斗鎮", "田尾鄉", "埤頭鄉", "溪州鄉","竹塘鄉", "二林鎮", "大城鄉", "芳苑鄉", "二水鄉"],
      "南投縣": ["南投市", "中寮鄉", "草屯鎮", "國姓鄉", "埔里鎮", "仁愛鄉", "名間鄉","集集鎮", "水里鄉", "魚池鄉", "信義鄉", "竹山鎮", "鹿谷鄉"],
      "雲林縣": ["斗南鎮", "大埤鄉", "虎尾鎮", "土庫鎮", "褒忠鄉", "東勢鄉", "台西鄉","崙背鄉", "麥寮鄉", "斗六市", "林內鄉", "古坑鄉", "莿桐鄉", "西螺鎮","二崙鄉", "北港鎮", "水林鄉", "口湖鄉", "四湖鄉", "元長鄉"],
      "嘉義市": ["東區", "西區"],
      "嘉義縣": ["番路鄉", "梅山鄉", "竹崎鄉", "阿里山鄉", "中埔鄉", "大埔鄉", "水上鄉","鹿草鄉", "太保市", "義竹鄉", "布袋鎮"],
      "台南市": ["中西區", "東區", "南區", "北區", "安平區", "安南區", "永康區", "歸仁區","新化區", "左鎮區", "玉井區", "楠西區", "南化區", "仁德區", "關廟區","龍崎區", "官田區", "麻豆區", "佳里區", "西港區", "七股區", "將軍區","學甲區", "北門區", "新營區", "後壁區", "白河區", "東山區", "六甲區","下營區", "柳營區", "鹽水區", "大內區", "山上區", "新市區", "安定區"],
      "高雄市": ["新興區", "前金區", "苓雅區", "鹽埕區", "鼓山區", "旗津區", "前鎮區","三民區", "楠梓區", "小港區", "左營區", "仁武區", "大社區", "岡山區","路竹區", "阿蓮區", "田寮區", "燕巢區", "橋頭區", "梓官區", "彌陀區","永安區", "湖內區", "鳳山區", "大寮區", "林園區", "鳥松區", "大樹區","橋頭區", "旗山區", "美濃區", "六龜區", "內門區", "杉林區", "甲仙區","桃源區", "那瑪夏區", "茂林區", "茄萣區"],
      "屏東縣": ["屏東市", "三地門鄉", "霧臺鄉", "瑪家鄉", "九如鄉", "里港鄉", "高樹鄉","鹽埔鄉", "長治鄉", "麟洛鄉", "竹田鄉", "內埔鄉", "萬巒鄉", "潮州鎮","泰武鄉", "來義鄉", "萬丹鄉", "崁頂鄉", "新埤鄉", "南州鄉", "林邊鄉","東港鎮", "琉球鄉", "佳冬鄉", "新園鄉", "枋寮鄉", "枋山鄉", "春日鄉","獅子鄉", "車城鄉", "牡丹鄉", "恆春鎮", "滿州鄉"],
      "台東縣": ["台東市", "綠島鄉", "蘭嶼鄉", "延平鄉", "卑南鄉", "鹿野鄉", "關山鎮","海端鄉", "池上鄉", "東河鄉", "成功鎮", "長濱鄉", "太麻里鄉", "金峰鄉","大武鄉", "達仁鄉"],
      "花蓮縣": ["花蓮市", "新城鄉", "秀林鄉", "吉安鄉", "壽豐鄉", "鳳林鎮", "光復鄉","豐濱鄉", "瑞穗鄉", "萬榮鄉", "玉里鎮", "卓溪鄉", "富里鄉"],
      "宜蘭縣": ["宜蘭市", "頭城鎮", "礁溪鄉", "壯圍鄉", "員山鄉", "羅東鎮", "三星鄉","大同鄉", "五結鄉", "冬山鄉", "蘇澳鎮", "南澳鄉"],
      "澎湖縣": ["馬公市", "西嶼鄉", "望安鄉", "七美鄉", "白沙鄉", "湖西鄉"],
      "金門縣": ["金沙鎮", "金湖鎮", "金寧鄉", "烈嶼鄉", "烏坵鄉"],
      "連江縣": ["南竿鄉", "北竿鄉", "莒光鄉", "東引鄉"]
    };

    const citySelect = document.getElementById('addressCity');
    const districtSelect = document.getElementById('addressDistrict');

    citySelect.addEventListener('change', () => {
      const city = citySelect.value;
      districtSelect.innerHTML = '';
      if (!city || !districtData[city]) {
        districtSelect.innerHTML = '<option value="">請先選擇城市</option>';
        districtSelect.disabled = true;
        return;
      }

      districtSelect.disabled = false;
      districtSelect.innerHTML = '<option value="">請選擇區域</option>';
      districtData[city].forEach(district => {
        const option = document.createElement('option');
        option.value = district;
        option.textContent = district;
        districtSelect.appendChild(option);
      });
    });

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!window.liff) {
        alert('請在 LINE APP 中開啟本頁');
        return;
      }

      let userId = '';
      try {
        await liff.init({ liffId: '2008128192-ANzL1oyW' });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        const profile = await liff.getProfile();
        userId = profile.userId;
      } catch (error) {
        alert('無法取得 LINE 用戶資料，請稍後再試');
        return;
      }

      const data = {
        userId: userId,
        name: document.getElementById('name').value.trim(),
        idNumber: document.getElementById('idNumber').value.trim(),
        birthday: document.getElementById('birthday').value,
        gender: document.getElementById('gender').value,
        phone: document.getElementById('phone').value.trim(),
        address: citySelect.value + districtSelect.value + document.getElementById('addressDetail').value.trim(),
        registerLocation: document.getElementById('registerLocation').value,
        memberLevel: '一般會員',
        totalPoints: 0
      };

      try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbztaK2IQ9rJqnzPLUL1Mznq0r3FJrkWyzmdzWsGlL61edPsTgB11JnTUDk0yjGnw_h4/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ page: 'register', ...data })
        });

        const result = await res.json();
        alert(result.message);
        if (result.success) {
          window.location.href = 'profile.html';
        }
      } catch (err) {
        alert('註冊失敗，請稍後重試');
        console.error(err);
      }
    });
  </script>
</body>
</html>
