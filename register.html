<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>會員註冊</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <form id="registerForm">
    <!-- 以下表單欄位同前，略 -->
    <input type="text" id="name" name="name" required>
    <input type="text" id="idNumber" name="idNumber" maxlength="10" required pattern="^[A-Z][12]\d{8}$">
    <input type="date" id="birthday" name="birthday" required>
    <select id="gender" name="gender" required>
      <option value="">請選擇</option>
      <option value="男">男</option>
      <option value="女">女</option>
    </select>
    <input type="tel" id="phone" name="phone" pattern="09\d{8}" required>
    <select id="registerLocation" name="registerLocation" required>
      <option value="">請選擇註冊據點</option>
      <option value="台北富豪">台北富豪</option>
    </select>
    <select id="addressCity" name="addressCity" required>
      <option value="">請選擇城市</option>
      <!-- 城市選項同前，略 -->
    </select>
    <select id="addressDistrict" name="addressDistrict" required>
      <option value="">請先選擇城市</option>
      <!-- 該根據城市動態改變 -->
    </select>
    <input type="text" id="addressDetail" name="addressDetail" placeholder="如街道門牌" required>
    
    <button type="submit" id="submitBtn">送出</button>
  </form>

  <script>
    // 動態變更區域邏輯同前，略

    let liffID = '';

    window.onload = () => {
      if (window.liff) {
        liff.init({ liffId: '2008128192-ANzL1oyW' }).then(() => {
          if (liff.isLoggedIn()) {
            liff.getProfile().then(profile => {
              liffID = profile.userId;
              console.log('LIFF userId:', liffID);
            });
          } else {
            liff.login();
          }
        });
      }
    };

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!liffID) {
        alert('尚未取得 LINE 用戶 ID，請用 LINE 開啟本頁並重試');
        return;
      }

      const data = {
        userId: liffID,
        name: document.getElementById('name').value.trim(),
        idNumber: document.getElementById('idNumber').value.trim(),
        birthday: document.getElementById('birthday').value,
        gender: document.getElementById('gender').value,
        phone: document.getElementById('phone').value.trim(),
        address: document.getElementById('addressCity').value + document.getElementById('addressDistrict').value + document.getElementById('addressDetail').value.trim(),
        registerLocation: document.getElementById('registerLocation').value,
        memberLevel: '一般會員',
        totalPoints: 0
      };

      console.log('送出註冊資料:', data);

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;

      try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbztaK2IQ9rJqnzPLUL1Mznq0r3FJrkWyzmdzWsGlL61edPsTgB11JnTUDk0yjGnw_h4/exec', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({page:'register', ...data})
        });

        const result = await res.json();
        alert(result.message);
        if (result.success) {
          window.location.href = 'profile.html';
        } else {
          submitBtn.disabled = false;
        }
      } catch (err) {
        alert('註冊失敗，請稍後重試');
        console.error(err);
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
