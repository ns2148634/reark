<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>預約設備</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <main>
    <section id="booking">
      <h2>預約設備</h2>
      <form id="bookingForm">
        <input type="hidden" id="userId" name="userId">
        <label>日期 <input type="date" id="date" name="date" required></label>
        <label>時段
          <select id="slot" name="slot" required></select>
        </label>
        <button type="submit">送出預約</button>
      </form>
      <div id="bookingResult"></div>
    </section>
  </main>
  <script>
    const liffId = '2008128192-ANzL1oyW';
    const API_BASE = "https://reark.ewn-utt.workers.dev";

    function genSlots() {
      let slotArr = [];
      let s = new Date(), today = new Date();
      s.setHours(11,0,0,0);
      for(let i=0;i<18;i++) {
        let h = String(s.getHours()).padStart(2,0);
        let m = String(s.getMinutes()).padStart(2,0);
        slotArr.push(h+":"+m);
        s.setMinutes(s.getMinutes()+30);
      }
      return slotArr;
    }
    async function liffInit() {
      await liff.init({ liffId });
      if (!liff.isLoggedIn()) liff.login();
      const profile = await liff.getProfile();
      return profile.userId;
    }
    async function getMember(userId) {
      let r = await fetch(`${API_BASE}/members?userId=${encodeURIComponent(userId)}`);
      let j = await r.json();
      if(j.values && j.values.length>1){
        let row = j.values[1];
        // ["註冊時間", "LINE用戶ID", "姓名", "身份證字號", "生日", "性別", "手機號碼", "居住地址", "註冊據點", "會員等級", "累計積點"]
        return {
          userId: row[1],
          name: row[2],
          phone: row[6],
          branch: row[8]
        }
      } else return {};
    }
    async function getAllReservations(d) {
      let r = await fetch(`${API_BASE}/reservations?date=${d}`);
      let j = await r.json();
      return j.values ? j.values.filter((row,i)=>i>0 && row[4]==d).map(r=>r[5]) : [];
    }
    async function getReserveCount(userId, d) {
      let r = await fetch(`${API_BASE}/reservations?userId=${encodeURIComponent(userId)}&date=${d}`);
      let j = await r.json();
      return j.values ? j.values.filter((row,i)=>i>0 && row[4]==d).length : 0;
    }
    async function book(post) {
      let r = await fetch(`${API_BASE}/reservations`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(post)
      });
      return await r.json();
    }
    window.addEventListener("DOMContentLoaded", async ()=>{
      let userId = await liffInit();
      document.getElementById("userId").value = userId;
      const dateEl = document.getElementById("date");
      const slotSel = document.getElementById("slot");
      const form = document.getElementById("bookingForm");
      const resultDom = document.getElementById("bookingResult");
      let member = await getMember(userId);
      if(!member.userId){ resultDom.innerHTML="請先註冊成會員"; form.style.display="none"; return; }
      dateEl.onchange = async () => {
        let pickDate = dateEl.value;
        slotSel.innerHTML = "";
        let taken = await getAllReservations(pickDate);
        genSlots().forEach(s=>{
          if(!taken.includes(s)){
            let opt = document.createElement("option");
            opt.value=s, opt.text=s;
            slotSel.appendChild(opt);
          }
        });
      };
      form.onsubmit = async function(e){
        e.preventDefault();
        let pickDate = dateEl.value, slot = slotSel.value;
        let row = await getMember(userId);
        let post = {
          branch: row.branch,
          userId: row.userId,
          phone: row.phone,
          name: row.name,
          date: pickDate,
          slot: slot
        };
        let res = await book(post);
        if(res.updates)
          resultDom.textContent = `預約完成！${pickDate} ${slot}`;
        else
          resultDom.textContent = "預約失敗";
      }
    });
  </script>
</body>
</html>
